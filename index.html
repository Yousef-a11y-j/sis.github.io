import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  onSnapshot, 
  query, 
  where,
  serverTimestamp,
  writeBatch
} from 'firebase/firestore';
import { 
  BookOpen, 
  Users, 
  GraduationCap, 
  Calendar, 
  Settings, 
  LogOut, 
  Plus, 
  Trash2, 
  FileText, 
  User, 
  Shield, 
  Search,
  CheckCircle,
  AlertCircle,
  Menu,
  X
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Constants & Helpers ---
const SEMESTERS = ['Fall 2025', 'Spring 2026'];
const DEPARTMENTS = ['Computer Science', 'Engineering', 'Business', 'Arts', 'Mathematics'];

const calculateGPA = (grade) => {
  if (grade >= 90) return 4.0;
  if (grade >= 85) return 3.7;
  if (grade >= 80) return 3.3;
  if (grade >= 75) return 3.0;
  if (grade >= 70) return 2.7;
  if (grade >= 65) return 2.3;
  if (grade >= 60) return 2.0;
  return 0.0;
};

const getGradeLetter = (grade) => {
  if (grade === null || grade === undefined) return '-';
  if (grade >= 90) return 'A';
  if (grade >= 85) return 'A-';
  if (grade >= 80) return 'B+';
  if (grade >= 75) return 'B';
  if (grade >= 70) return 'B-';
  if (grade >= 65) return 'C+';
  if (grade >= 60) return 'C';
  if (grade >= 50) return 'D';
  return 'F';
};

// --- Components ---

// 1. UI Components
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = 'primary', className = "", disabled = false }) => {
  const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
    secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:bg-slate-50",
    danger: "bg-red-50 text-red-600 hover:bg-red-100 disabled:bg-red-50",
    outline: "border border-slate-300 text-slate-700 hover:bg-slate-50"
  };
  return (
    <button 
      onClick={onClick} 
      disabled={disabled} 
      className={`${baseStyle} ${variants[variant]} ${className}`}
    >
      {children}
    </button>
  );
};

const Badge = ({ children, type = 'neutral' }) => {
  const styles = {
    success: "bg-green-100 text-green-700",
    warning: "bg-amber-100 text-amber-700",
    danger: "bg-red-100 text-red-700",
    neutral: "bg-slate-100 text-slate-700",
    blue: "bg-blue-100 text-blue-700"
  };
  return (
    <span className={`px-2.5 py-0.5 rounded-full text-xs font-semibold ${styles[type]}`}>
      {children}
    </span>
  );
};

// 2. Auth / Login Component
const LoginScreen = ({ onLogin }) => {
  return (
    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
      <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
        <div className="flex justify-center mb-6">
          <div className="bg-blue-600 p-4 rounded-xl shadow-lg shadow-blue-200">
            <GraduationCap size={48} className="text-white" />
          </div>
        </div>
        <h1 className="text-3xl font-bold text-center text-slate-800 mb-2">University SIS</h1>
        <p className="text-center text-slate-500 mb-8">Select a role to enter the demo environment</p>
        
        <div className="space-y-3">
          <button 
            onClick={() => onLogin('student', { id: 'std_001', name: 'Alice Student', email: 'alice@uni.edu', department: 'Computer Science' })}
            className="w-full p-4 border border-slate-200 rounded-xl hover:border-blue-500 hover:shadow-md transition-all flex items-center gap-4 group text-left"
          >
            <div className="bg-blue-100 p-3 rounded-full group-hover:bg-blue-600 transition-colors">
              <User className="text-blue-600 group-hover:text-white" size={20} />
            </div>
            <div>
              <h3 className="font-semibold text-slate-800">Student Portal</h3>
              <p className="text-sm text-slate-500">Access courses, grades, and profile</p>
            </div>
          </button>

          <button 
            onClick={() => onLogin('doctor', { id: 'doc_001', name: 'Dr. Smith', email: 'smith@uni.edu', department: 'Computer Science' })}
            className="w-full p-4 border border-slate-200 rounded-xl hover:border-emerald-500 hover:shadow-md transition-all flex items-center gap-4 group text-left"
          >
            <div className="bg-emerald-100 p-3 rounded-full group-hover:bg-emerald-600 transition-colors">
              <Users className="text-emerald-600 group-hover:text-white" size={20} />
            </div>
            <div>
              <h3 className="font-semibold text-slate-800">Instructor Portal</h3>
              <p className="text-sm text-slate-500">Manage classes, attendance, and grading</p>
            </div>
          </button>

          <button 
            onClick={() => onLogin('admin', { id: 'adm_001', name: 'Admin Staff', email: 'admin@uni.edu' })}
            className="w-full p-4 border border-slate-200 rounded-xl hover:border-purple-500 hover:shadow-md transition-all flex items-center gap-4 group text-left"
          >
            <div className="bg-purple-100 p-3 rounded-full group-hover:bg-purple-600 transition-colors">
              <Shield className="text-purple-600 group-hover:text-white" size={20} />
            </div>
            <div>
              <h3 className="font-semibold text-slate-800">Admin Console</h3>
              <p className="text-sm text-slate-500">System configuration and data management</p>
            </div>
          </button>
        </div>
        
        <div className="mt-8 text-center text-xs text-slate-400">
          Secure Academic System v2.5.0
        </div>
      </div>
    </div>
  );
};

// 3. Layout Components
const Sidebar = ({ role, activeTab, setActiveTab, onLogout, user }) => {
  const [isOpen, setIsOpen] = useState(false);

  const menuItems = {
    student: [
      { id: 'dashboard', label: 'Dashboard', icon: CheckCircle },
      { id: 'registration', label: 'Course Reg.', icon: BookOpen },
      { id: 'academics', label: 'My Grades', icon: FileText },
    ],
    doctor: [
      { id: 'dashboard', label: 'Dashboard', icon: CheckCircle },
      { id: 'teaching', label: 'My Classes', icon: Users },
    ],
    admin: [
      { id: 'dashboard', label: 'Overview', icon: CheckCircle },
      { id: 'courses', label: 'Courses', icon: BookOpen },
      { id: 'system', label: 'Settings', icon: Settings },
    ]
  };

  const currentMenu = menuItems[role] || [];

  return (
    <>
      <div className="md:hidden fixed top-0 left-0 right-0 h-16 bg-white border-b border-slate-200 z-50 flex items-center justify-between px-4">
        <span className="font-bold text-lg text-slate-800">UniSIS</span>
        <button onClick={() => setIsOpen(!isOpen)} className="p-2">
          {isOpen ? <X /> : <Menu />}
        </button>
      </div>

      <div className={`fixed inset-y-0 left-0 w-64 bg-slate-900 text-slate-300 transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-200 ease-in-out z-40 flex flex-col`}>
        <div className="p-6 border-b border-slate-800 flex items-center gap-3">
          <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
            <GraduationCap className="text-white" size={18} />
          </div>
          <h1 className="text-xl font-bold text-white">UniSIS</h1>
        </div>

        <div className="p-6">
          <div className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Menu</div>
          <nav className="space-y-2">
            {currentMenu.map(item => (
              <button
                key={item.id}
                onClick={() => { setActiveTab(item.id); setIsOpen(false); }}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 text-slate-400'}`}
              >
                <item.icon size={20} />
                <span className="font-medium">{item.label}</span>
              </button>
            ))}
          </nav>
        </div>

        <div className="mt-auto p-6 border-t border-slate-800">
          <div className="flex items-center gap-3 mb-6">
            <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center">
              <span className="font-bold text-white">{user.name.charAt(0)}</span>
            </div>
            <div className="overflow-hidden">
              <div className="font-medium text-white truncate">{user.name}</div>
              <div className="text-xs text-slate-500 capitalize">{role}</div>
            </div>
          </div>
          <button 
            onClick={onLogout}
            className="w-full flex items-center gap-3 px-4 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-red-400 transition-colors"
          >
            <LogOut size={20} />
            <span>Sign Out</span>
          </button>
        </div>
      </div>
      
      {isOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setIsOpen(false)} />}
    </>
  );
};

// --- View Components ---

// 1. Student Views
const StudentDashboard = ({ user, enrollments }) => {
  // Calculations
  const activeEnrollments = enrollments.filter(e => e.semester === 'Fall 2025'); // Assuming current
  const totalCredits = activeEnrollments.reduce((sum, e) => sum + (e.courseCredits || 0), 0);
  const completedCourses = enrollments.filter(e => e.grade !== null && e.grade !== undefined);
  
  let totalPoints = 0;
  let totalGradedCredits = 0;
  
  completedCourses.forEach(e => {
    const credits = e.courseCredits || 3;
    const gpa = calculateGPA(e.grade);
    totalPoints += (gpa * credits);
    totalGradedCredits += credits;
  });

  const cumulativeGPA = totalGradedCredits > 0 ? (totalPoints / totalGradedCredits).toFixed(2) : "0.00";

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-end">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">Welcome back, {user.name.split(' ')[0]}</h2>
          <p className="text-slate-500">Here's what's happening with your academics today.</p>
        </div>
        <span className="hidden md:inline-block px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium">Fall 2025 Semester</span>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card className="p-6 border-l-4 border-l-blue-500">
          <div className="flex items-center justify-between mb-4">
            <div className="p-2 bg-blue-100 rounded-lg text-blue-600"><GraduationCap size={24} /></div>
            <Badge type="blue">Cumulative</Badge>
          </div>
          <div className="text-3xl font-bold text-slate-800 mb-1">{cumulativeGPA}</div>
          <div className="text-sm text-slate-500">Current GPA</div>
        </Card>
        
        <Card className="p-6 border-l-4 border-l-emerald-500">
          <div className="flex items-center justify-between mb-4">
            <div className="p-2 bg-emerald-100 rounded-lg text-emerald-600"><BookOpen size={24} /></div>
            <Badge type="success">Active</Badge>
          </div>
          <div className="text-3xl font-bold text-slate-800 mb-1">{activeEnrollments.length}</div>
          <div className="text-sm text-slate-500">Enrolled Courses</div>
        </Card>

        <Card className="p-6 border-l-4 border-l-purple-500">
           <div className="flex items-center justify-between mb-4">
            <div className="p-2 bg-purple-100 rounded-lg text-purple-600"><Calendar size={24} /></div>
            <Badge type="neutral">Credits</Badge>
          </div>
          <div className="text-3xl font-bold text-slate-800 mb-1">{totalCredits}</div>
          <div className="text-sm text-slate-500">Registered Hours</div>
        </Card>
      </div>

      <h3 className="text-lg font-bold text-slate-800 mt-8">Current Schedule</h3>
      <div className="grid grid-cols-1 gap-4">
        {activeEnrollments.length === 0 ? (
          <div className="p-8 text-center bg-slate-50 rounded-xl border border-dashed border-slate-300">
            <p className="text-slate-500">No classes registered for this semester yet.</p>
          </div>
        ) : (
          activeEnrollments.map(e => (
            <Card key={e.id} className="p-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center font-bold text-slate-600">
                  {e.courseCode?.substring(0,2)}
                </div>
                <div>
                  <h4 className="font-bold text-slate-800">{e.courseTitle}</h4>
                  <p className="text-sm text-slate-500">{e.courseCode} • {e.courseCredits} Credits</p>
                </div>
              </div>
              <div className="flex flex-col md:items-end">
                <div className="text-sm font-medium text-slate-700">{e.schedule || 'TBA'}</div>
                <div className="text-xs text-slate-500">{e.instructorName}</div>
              </div>
            </Card>
          ))
        )}
      </div>
    </div>
  );
};

const StudentRegistration = ({ user, courses, enrollments, onRegister, onDrop }) => {
  const [searchTerm, setSearchTerm] = useState('');
  
  const myCourseIds = enrollments.map(e => e.courseId);
  const availableCourses = courses.filter(c => 
    !myCourseIds.includes(c.id) && 
    (c.title.toLowerCase().includes(searchTerm.toLowerCase()) || c.code.toLowerCase().includes(searchTerm.toLowerCase()))
  );

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">Course Registration</h2>
          <p className="text-slate-500">Add or drop courses for the upcoming semester.</p>
        </div>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
          <input 
            type="text" 
            placeholder="Search courses..." 
            className="pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-64"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span className="w-2 h-2 rounded-full bg-blue-500"></span> Available Courses
          </h3>
          <div className="space-y-3">
            {availableCourses.length === 0 ? (
              <p className="text-slate-500 italic">No courses found matching your search.</p>
            ) : (
              availableCourses.map(course => (
                <Card key={course.id} className="p-4 hover:shadow-md transition-shadow">
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-bold text-slate-800">{course.code}</span>
                        <span className="text-xs px-2 py-0.5 bg-slate-100 text-slate-600 rounded">{course.credits} Cr</span>
                      </div>
                      <h4 className="font-semibold text-blue-900 mb-1">{course.title}</h4>
                      <p className="text-xs text-slate-500 mb-3">{course.schedule} • {course.instructorName}</p>
                      <div className="text-xs flex gap-2">
                        <Badge type={course.enrolled >= course.capacity ? 'danger' : 'success'}>
                          {course.enrolled}/{course.capacity} Seats
                        </Badge>
                      </div>
                    </div>
                    <Button 
                      size="sm" 
                      onClick={() => onRegister(course)}
                      disabled={course.enrolled >= course.capacity}
                      className="text-sm px-3 py-1"
                    >
                      {course.enrolled >= course.capacity ? 'Full' : 'Add'}
                    </Button>
                  </div>
                </Card>
              ))
            )}
          </div>
        </div>

        <div>
          <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span className="w-2 h-2 rounded-full bg-emerald-500"></span> My Selection
          </h3>
          <div className="space-y-3">
            {enrollments.length === 0 ? (
              <div className="p-6 border-2 border-dashed border-slate-200 rounded-xl text-center">
                <p className="text-slate-400">You haven't registered for any courses yet.</p>
              </div>
            ) : (
              enrollments.map(enrollment => (
                <Card key={enrollment.id} className="p-4 bg-blue-50/50 border-blue-100">
                  <div className="flex justify-between items-center">
                    <div>
                      <h4 className="font-bold text-slate-800">{enrollment.courseTitle}</h4>
                      <p className="text-xs text-slate-500">{enrollment.courseCode} • {enrollment.courseCredits} Credits</p>
                    </div>
                    <button 
                      onClick={() => onDrop(enrollment.id, enrollment.courseId)}
                      className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                      title="Drop Course"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                </Card>
              ))
            )}
            
            {enrollments.length > 0 && (
              <div className="mt-4 pt-4 border-t border-slate-200 flex justify-between items-center px-2">
                <span className="font-medium text-slate-600">Total Credits</span>
                <span className="font-bold text-slate-900 text-lg">
                  {enrollments.reduce((sum, e) => sum + (e.courseCredits || 0), 0)}
                </span>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

const StudentAcademics = ({ enrollments }) => {
  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-slate-800">Academic Record</h2>
        <p className="text-slate-500">View your grades and unofficial transcript.</p>
      </div>

      <Card className="overflow-hidden">
        <div className="bg-slate-50 px-6 py-4 border-b border-slate-200">
          <h3 className="font-bold text-slate-700">Course History</h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-left text-sm">
            <thead className="bg-white text-slate-500 border-b border-slate-100">
              <tr>
                <th className="px-6 py-4 font-medium">Course</th>
                <th className="px-6 py-4 font-medium">Semester</th>
                <th className="px-6 py-4 font-medium">Credits</th>
                <th className="px-6 py-4 font-medium">Grade %</th>
                <th className="px-6 py-4 font-medium">Letter</th>
                <th className="px-6 py-4 font-medium">GPA</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {enrollments.map(e => {
                const grade = e.grade;
                const letter = getGradeLetter(grade);
                const gpa = grade ? calculateGPA(grade).toFixed(1) : '-';
                
                return (
                  <tr key={e.id} className="hover:bg-slate-50">
                    <td className="px-6 py-4">
                      <div className="font-medium text-slate-900">{e.courseTitle}</div>
                      <div className="text-xs text-slate-500">{e.courseCode}</div>
                    </td>
                    <td className="px-6 py-4 text-slate-600">{e.semester}</td>
                    <td className="px-6 py-4 text-slate-600">{e.courseCredits}</td>
                    <td className="px-6 py-4 text-slate-900 font-medium">
                      {grade !== undefined && grade !== null ? grade : <span className="text-slate-400 italic">In Progress</span>}
                    </td>
                    <td className="px-6 py-4">
                      <Badge type={grade >= 60 ? 'success' : grade ? 'danger' : 'neutral'}>{letter}</Badge>
                    </td>
                    <td className="px-6 py-4 font-mono text-slate-600">{gpa}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
};

// 2. Doctor Views
const DoctorDashboard = ({ user, courses }) => {
  const myCourses = courses.filter(c => c.instructorId === user.id);
  
  return (
    <div className="space-y-6">
      <div className="flex justify-between items-end">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">Instructor Dashboard</h2>
          <p className="text-slate-500">Manage your courses and student grading.</p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card className="p-6 bg-gradient-to-br from-blue-600 to-blue-800 text-white shadow-blue-200">
          <div className="text-blue-100 mb-1">Total Classes</div>
          <div className="text-3xl font-bold">{myCourses.length}</div>
        </Card>
        <Card className="p-6 bg-white border border-slate-200">
          <div className="text-slate-500 mb-1">Total Students</div>
          <div className="text-3xl font-bold text-slate-800">
            {myCourses.reduce((acc, c) => acc + (c.enrolled || 0), 0)}
          </div>
        </Card>
         <Card className="p-6 bg-white border border-slate-200">
          <div className="text-slate-500 mb-1">Pending Grades</div>
          <div className="text-3xl font-bold text-slate-800">--</div>
        </Card>
      </div>

      <h3 className="text-lg font-bold text-slate-800 mt-6">My Courses</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {myCourses.map(course => (
          <Card key={course.id} className="p-5 hover:shadow-md transition-shadow cursor-pointer border-l-4 border-l-blue-500">
            <div className="flex justify-between items-start mb-4">
              <div>
                <h4 className="text-lg font-bold text-slate-800">{course.title}</h4>
                <p className="text-sm text-slate-500">{course.code}</p>
              </div>
              <Badge type="neutral">{course.enrolled} Students</Badge>
            </div>
            <div className="flex items-center gap-4 text-sm text-slate-600">
               <span className="flex items-center gap-1"><Calendar size={14}/> {course.schedule}</span>
               <span className="flex items-center gap-1"><Users size={14}/> Room 304</span>
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
};

const DoctorClasses = ({ user, courses, allEnrollments, onUpdateGrade }) => {
  const [selectedCourseId, setSelectedCourseId] = useState(null);
  
  const myCourses = courses.filter(c => c.instructorId === user.id);
  const selectedCourse = myCourses.find(c => c.id === selectedCourseId);
  
  // Get enrollments for selected course
  const courseEnrollments = allEnrollments.filter(e => e.courseId === selectedCourseId);

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-slate-800">Grade Management</h2>
        <p className="text-slate-500">Select a course to view roster and submit grades.</p>
      </div>

      <div className="flex flex-col lg:flex-row gap-6 h-[600px]">
        {/* Course List Sidebar */}
        <div className="w-full lg:w-1/3 bg-white rounded-xl border border-slate-200 overflow-hidden flex flex-col">
          <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-700">
            Your Courses
          </div>
          <div className="overflow-y-auto flex-1 p-2 space-y-2">
            {myCourses.map(course => (
              <button
                key={course.id}
                onClick={() => setSelectedCourseId(course.id)}
                className={`w-full text-left p-3 rounded-lg transition-colors ${selectedCourseId === course.id ? 'bg-blue-50 border border-blue-200 shadow-sm' : 'hover:bg-slate-50 border border-transparent'}`}
              >
                <div className="font-bold text-slate-800">{course.code}</div>
                <div className="text-sm text-slate-600 truncate">{course.title}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Grading Area */}
        <div className="w-full lg:w-2/3 bg-white rounded-xl border border-slate-200 overflow-hidden flex flex-col">
          {!selectedCourse ? (
            <div className="flex-1 flex flex-col items-center justify-center text-slate-400 p-8">
              <BookOpen size={48} className="mb-4 opacity-20" />
              <p>Select a course from the left to manage grades.</p>
            </div>
          ) : (
            <>
              <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div>
                  <h3 className="text-xl font-bold text-slate-800">{selectedCourse.title}</h3>
                  <p className="text-sm text-slate-500">{courseEnrollments.length} Students Enrolled</p>
                </div>
                <Button variant="secondary" onClick={() => {}}>Export CSV</Button>
              </div>
              
              <div className="overflow-y-auto flex-1 p-6">
                {courseEnrollments.length === 0 ? (
                  <p className="text-center text-slate-500 italic mt-8">No students enrolled yet.</p>
                ) : (
                  <table className="w-full">
                    <thead>
                      <tr className="text-left text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                        <th className="pb-3">Student Name</th>
                        <th className="pb-3">ID</th>
                        <th className="pb-3">Grade (0-100)</th>
                        <th className="pb-3">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {courseEnrollments.map(enrollment => (
                        <tr key={enrollment.id} className="group">
                          <td className="py-4 font-medium text-slate-800">{enrollment.studentName}</td>
                          <td className="py-4 text-slate-500 text-sm">{enrollment.studentId}</td>
                          <td className="py-4">
                            <input 
                              type="number" 
                              min="0" 
                              max="100" 
                              placeholder="-"
                              defaultValue={enrollment.grade}
                              className="w-20 px-3 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                              id={`grade-${enrollment.id}`}
                            />
                          </td>
                          <td className="py-4">
                            <Button 
                              size="sm" 
                              variant="primary" 
                              className="text-xs px-3 py-1"
                              onClick={() => {
                                const val = document.getElementById(`grade-${enrollment.id}`).value;
                                if(val !== '') onUpdateGrade(enrollment.id, parseInt(val));
                              }}
                            >
                              Save
                            </Button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
};

// 3. Admin Views
const AdminDashboard = ({ courses, users }) => {
  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-slate-800">System Overview</h2>
        <p className="text-slate-500">University metrics and system status.</p>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card className="p-4 border-l-4 border-blue-500">
          <div className="text-slate-500 text-sm">Total Courses</div>
          <div className="text-2xl font-bold text-slate-800">{courses.length}</div>
        </Card>
        <Card className="p-4 border-l-4 border-emerald-500">
           <div className="text-slate-500 text-sm">Active Students</div>
          <div className="text-2xl font-bold text-slate-800">1,240</div>
        </Card>
        <Card className="p-4 border-l-4 border-purple-500">
           <div className="text-slate-500 text-sm">Faculty Members</div>
          <div className="text-2xl font-bold text-slate-800">86</div>
        </Card>
        <Card className="p-4 border-l-4 border-amber-500">
           <div className="text-slate-500 text-sm">System Status</div>
          <div className="text-2xl font-bold text-emerald-600 flex items-center gap-2">
            <span className="w-3 h-3 rounded-full bg-emerald-500"></span> Online
          </div>
        </Card>
      </div>

      <Card className="p-6">
        <h3 className="font-bold text-slate-800 mb-4">Quick Actions</h3>
        <div className="flex gap-4">
          <Button variant="outline">Generate Reports</Button>
          <Button variant="outline">Manage Semesters</Button>
          <Button variant="outline">View Audit Logs</Button>
        </div>
      </Card>
    </div>
  );
};

const AdminCourses = ({ courses, onAddCourse, onDeleteCourse }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [newCourse, setNewCourse] = useState({
    title: '', code: '', credits: 3, capacity: 30, instructorName: 'Dr. Smith', instructorId: 'doc_001', schedule: 'Mon/Wed 10:00 AM'
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onAddCourse(newCourse);
    setIsModalOpen(false);
    setNewCourse({ title: '', code: '', credits: 3, capacity: 30, instructorName: 'Dr. Smith', instructorId: 'doc_001', schedule: 'Mon/Wed 10:00 AM' });
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">Course Management</h2>
          <p className="text-slate-500">Add, edit, or remove courses from the catalog.</p>
        </div>
        <Button onClick={() => setIsModalOpen(true)}><Plus size={18} /> New Course</Button>
      </div>

      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <table className="w-full text-left">
          <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-bold border-b border-slate-200">
            <tr>
              <th className="px-6 py-3">Code</th>
              <th className="px-6 py-3">Title</th>
              <th className="px-6 py-3">Instructor</th>
              <th className="px-6 py-3">Credits</th>
              <th className="px-6 py-3">Enrollment</th>
              <th className="px-6 py-3">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {courses.map(course => (
              <tr key={course.id} className="hover:bg-slate-50">
                <td className="px-6 py-3 font-mono text-sm">{course.code}</td>
                <td className="px-6 py-3 font-medium text-slate-800">{course.title}</td>
                <td className="px-6 py-3 text-sm text-slate-600">{course.instructorName}</td>
                <td className="px-6 py-3 text-sm">{course.credits}</td>
                <td className="px-6 py-3 text-sm">
                  <div className="flex items-center gap-2">
                    <div className="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                      <div 
                        className="h-full bg-blue-500" 
                        style={{ width: `${(course.enrolled / course.capacity) * 100}%` }}
                      ></div>
                    </div>
                    <span className="text-xs text-slate-500">{course.enrolled}/{course.capacity}</span>
                  </div>
                </td>
                <td className="px-6 py-3">
                  <button 
                    onClick={() => onDeleteCourse(course.id)}
                    className="text-slate-400 hover:text-red-500 transition-colors"
                  >
                    <Trash2 size={18} />
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {isModalOpen && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6">
            <h3 className="text-xl font-bold mb-4">Add New Course</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Course Code</label>
                  <input required type="text" className="w-full p-2 border rounded-lg" placeholder="e.g. CS101" value={newCourse.code} onChange={e => setNewCourse({...newCourse, code: e.target.value})} />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Credits</label>
                  <input required type="number" className="w-full p-2 border rounded-lg" value={newCourse.credits} onChange={e => setNewCourse({...newCourse, credits: parseInt(e.target.value)})} />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Course Title</label>
                <input required type="text" className="w-full p-2 border rounded-lg" placeholder="Intro to Programming" value={newCourse.title} onChange={e => setNewCourse({...newCourse, title: e.target.value})} />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Capacity</label>
                  <input required type="number" className="w-full p-2 border rounded-lg" value={newCourse.capacity} onChange={e => setNewCourse({...newCourse, capacity: parseInt(e.target.value)})} />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Schedule</label>
                  <input required type="text" className="w-full p-2 border rounded-lg" placeholder="Mon/Wed 10am" value={newCourse.schedule} onChange={e => setNewCourse({...newCourse, schedule: e.target.value})} />
                </div>
              </div>
              
              <div className="flex justify-end gap-3 mt-6">
                <Button variant="secondary" onClick={() => setIsModalOpen(false)} type="button">Cancel</Button>
                <Button variant="primary" type="submit">Create Course</Button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

const AdminSystem = ({ onSeedData }) => (
  <div className="space-y-6">
     <div>
        <h2 className="text-2xl font-bold text-slate-800">System Settings</h2>
        <p className="text-slate-500">Configure global application settings.</p>
      </div>

      <Card className="p-6">
        <h3 className="font-bold text-slate-800 mb-4 text-lg">Demo Data Management</h3>
        <p className="text-slate-600 mb-6 max-w-2xl">
          Initialize the database with sample courses, students, and enrollments. 
          Use this to test the Student and Doctor portals immediately.
        </p>
        <Button onClick={onSeedData} variant="primary">
          <Settings size={18} /> Initialize Demo Data
        </Button>
      </Card>
  </div>
);


// --- Main Application Shell ---

export default function UniversitySIS() {
  const [currentUser, setCurrentUser] = useState(null); // { role: 'student'|'doctor'|'admin', id, name, ... }
  const [activeTab, setActiveTab] = useState('dashboard');
  const [loading, setLoading] = useState(true);
  const [firebaseUser, setFirebaseUser] = useState(null); // Track actual Firebase Auth user
  
  // Data State
  const [courses, setCourses] = useState([]);
  const [enrollments, setEnrollments] = useState([]);
  const [allEnrollments, setAllEnrollments] = useState([]); // For Admin/Doc

  // 1. Authentication Handlers
  useEffect(() => {
    // Robust Auth Pattern
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          // Priority: Custom token from environment
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          // Fallback: Anonymous auth
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth initialization failed:", err);
      }
    };
    initAuth();

    // Listener for auth state changes
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setFirebaseUser(user);
      if (user) {
        setLoading(false);
      }
    });

    return () => unsubscribe();
  }, []);

  const handleLogin = (role, userData) => {
    setCurrentUser({ ...userData, role });
    setActiveTab('dashboard');
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setActiveTab('dashboard');
  };

  // 2. Data Fetching
  useEffect(() => {
    // Guard: Only fetch if we have BOTH a Firebase user (token) AND a selected app role
    if (!firebaseUser || !currentUser) return;

    // Fetch Courses (Public)
    const coursesQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'courses'));
    const unsubCourses = onSnapshot(coursesQuery, (snapshot) => {
      setCourses(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
    }, (err) => console.error("Courses fetch error", err));

    // Fetch Enrollments (Public)
    const enrollmentsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'enrollments'));
    const unsubEnrollments = onSnapshot(enrollmentsQuery, (snapshot) => {
      const all = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      setAllEnrollments(all);
      
      // Filter for current student
      if (currentUser.role === 'student') {
        setEnrollments(all.filter(e => e.studentId === currentUser.id));
      }
    }, (err) => console.error("Enrollments fetch error", err));

    return () => {
      unsubCourses();
      unsubEnrollments();
    };
  }, [firebaseUser, currentUser]);

  // 3. Actions
  const handleRegister = async (course) => {
    if (!firebaseUser) return;
    if (enrollments.some(e => e.courseId === course.id)) return;
    
    // Add Enrollment
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'enrollments'), {
      studentId: currentUser.id,
      studentName: currentUser.name,
      courseId: course.id,
      courseTitle: course.title,
      courseCode: course.code,
      courseCredits: course.credits,
      instructorName: course.instructorName,
      semester: 'Fall 2025',
      grade: null,
      enrolledAt: serverTimestamp()
    });

    // Update Course Count
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', course.id), {
      enrolled: (course.enrolled || 0) + 1
    });
  };

  const handleDrop = async (enrollmentId, courseId) => {
    if (!firebaseUser) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'enrollments', enrollmentId));
    
    // Decrease Count
    const course = courses.find(c => c.id === courseId);
    if(course) {
       await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId), {
        enrolled: Math.max(0, (course.enrolled || 0) - 1)
      });
    }
  };

  const handleUpdateGrade = async (enrollmentId, newGrade) => {
    if (!firebaseUser) return;
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'enrollments', enrollmentId), {
      grade: newGrade
    });
  };

  const handleAddCourse = async (courseData) => {
    if (!firebaseUser) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'courses'), {
      ...courseData,
      enrolled: 0
    });
  };

  const handleDeleteCourse = async (courseId) => {
    if (!firebaseUser) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId));
  };

  const seedData = async () => {
    if (!firebaseUser) return;
    const batch = writeBatch(db);
    const demoCourses = [
      { title: 'Intro to Computer Science', code: 'CS101', credits: 4, capacity: 50, enrolled: 0, instructorName: 'Dr. Smith', instructorId: 'doc_001', schedule: 'Mon/Wed 09:00 AM' },
      { title: 'Data Structures', code: 'CS201', credits: 4, capacity: 40, enrolled: 0, instructorName: 'Dr. Smith', instructorId: 'doc_001', schedule: 'Tue/Thu 11:00 AM' },
      { title: 'Calculus I', code: 'MATH101', credits: 3, capacity: 60, enrolled: 0, instructorName: 'Prof. Johnson', instructorId: 'doc_002', schedule: 'Mon/Wed/Fri 10:00 AM' },
      { title: 'Digital Logic', code: 'EE205', credits: 3, capacity: 30, enrolled: 0, instructorName: 'Dr. Lee', instructorId: 'doc_003', schedule: 'Tue/Thu 02:00 PM' },
    ];

    demoCourses.forEach(c => {
      const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'courses'));
      batch.set(ref, c);
    });

    await batch.commit();
    alert('Demo data initialized! Try logging in as a Student.');
  };

  // --- Render ---
  
  if (loading) return <div className="h-screen flex items-center justify-center text-slate-500">Loading SIS...</div>;

  if (!currentUser) return <LoginScreen onLogin={handleLogin} />;

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row">
      <Sidebar 
        role={currentUser.role} 
        activeTab={activeTab} 
        setActiveTab={setActiveTab} 
        onLogout={handleLogout}
        user={currentUser}
      />
      
      <main className="flex-1 md:ml-64 p-6 md:p-8 overflow-y-auto h-screen">
        <div className="max-w-6xl mx-auto">
          {/* Header */}
          <div className="mb-8 hidden md:block">
             <h1 className="text-2xl font-bold text-slate-800 capitalize">
               {currentUser.role} Portal
             </h1>
             <p className="text-slate-500 text-sm">{new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
          </div>

          {/* Views Logic */}
          {currentUser.role === 'student' && (
            <>
              {activeTab === 'dashboard' && <StudentDashboard user={currentUser} enrollments={enrollments} />}
              {activeTab === 'registration' && <StudentRegistration user={currentUser} courses={courses} enrollments={enrollments} onRegister={handleRegister} onDrop={handleDrop} />}
              {activeTab === 'academics' && <StudentAcademics enrollments={enrollments} />}
            </>
          )}

          {currentUser.role === 'doctor' && (
            <>
              {activeTab === 'dashboard' && <DoctorDashboard user={currentUser} courses={courses} />}
              {activeTab === 'teaching' && <DoctorClasses user={currentUser} courses={courses} allEnrollments={allEnrollments} onUpdateGrade={handleUpdateGrade} />}
            </>
          )}

          {currentUser.role === 'admin' && (
            <>
              {activeTab === 'dashboard' && <AdminDashboard courses={courses} />}
              {activeTab === 'courses' && <AdminCourses courses={courses} onAddCourse={handleAddCourse} onDeleteCourse={handleDeleteCourse} />}
              {activeTab === 'system' && <AdminSystem onSeedData={seedData} />}
            </>
          )}
        </div>
      </main>
    </div>
  );
}
